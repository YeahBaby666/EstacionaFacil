<html xmlns:th="http://www.thymeleaf.org" th:replace="~{_layout :: layout(~{::main}, 'Parqueo en Vivo')}">

<main class="container mx-auto p-4">
    
    <!-- Mensaje de error (si falla el /salir) -->
    <div th:if="${error}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        <span th:text="${error}"></span>
    </div>
    
    <!-- Panel de Control (Selección de vehículo y Salida) -->
    <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
        <div th:if="${reservaActiva == null}">
            <h3 class="text-lg font-semibold mb-2">1. Seleccione su vehículo para reservar:</h3>
            <select id="selectVehiculo" class="w-full p-2 border rounded">
                <option value="">-- Mis Vehículos --</option>
                <option th:each="v : ${vehiculos}" th:value="${v.idVehiculo}" th:text="|${v.placa} (${v.modelo})|"></option>
            </select>
            <p class="text-sm text-slate-600 mt-2">Luego, haga clic en un espacio 'DISPONIBLE'.</p>
        </div>
        
        <div th:if="${reservaActiva != null && reservaActiva.estado.name() == 'PENDIENTE'}">
            <h3 class="text-lg font-semibold mb-2">2. Confirme su llegada:</h3>
            <p>Tiene una reserva PENDIENTE en el espacio <b th:text="${reservaActiva.espacio.ubicacion}"></b>.</p>
            <p class="text-sm text-slate-600 mt-2">Haga clic en su espacio 'RESERVADO' para confirmar su estacionamiento.</p>
        </div>
        
        <div th:if="${reservaActiva != null && reservaActiva.estado.name() == 'ACTIVA'}">
            <h3 class="text-lg font-semibold mb-2">3. Salir y Pagar (Vía Thymeleaf):</h3>
            <p>Está estacionado en el espacio <b th:text="${reservaActiva.espacio.ubicacion}"></b>.</p>
            <form th:action="@{/salir}" method="post" class="mt-2">
                <input type="hidden" name="idReserva" th:value="${reservaActiva.idReserva}" />
                <button type="submit" class="w-full bg-red-500 text-white font-bold py-2 px-4 rounded hover:bg-red-600">
                    Finalizar Estacionamiento y Pagar
                </button>
            </form>
        </div>
    </div>
    
    <!-- Leyenda de Colores -->
    <div class="flex justify-center space-x-4 mb-4">
        <div><span class="inline-block w-4 h-4 rounded disponible mr-1"></span> Disponible</div>
        <div><span class="inline-block w-4 h-4 rounded reservado mr-1"></span> Reservado</div>
        <div><span class="inline-block w-4 h-4 rounded ocupado mr-1"></span> Ocupado</div>
    </div>

    <!-- Cuadrícula de Espacios (Renderizado inicial con Thymeleaf) -->
    <div id="parqueo-grid" class="grid grid-cols-5 md:grid-cols-10 gap-4">
        <div th:each="e : ${espacios}" 
             th:id="|espacio-${e.idEspacio}|"
             th:data-id="${e.idEspacio}"             
             th:classappend="|espacio ${
                 e.estado == T(utp.gestionparqueo.sistema_parqueo.model.entity.enums.EstadoEspacio).DISPONIBLE ? 'disponible' :
                 (e.estado == T(utp.gestionparqueo.sistema_parqueo.model.entity.enums.EstadoEspacio).RESERVADO ? 'reservado' : 'ocupado')
             }|"
             class="p-4 rounded-lg shadow text-center font-bold cursor-pointer">
            <span class="block text-xl" th:text="${e.ubicacion}">A-01</span>
            <span class="text-xs placa" th:text="${ (e.estado.name() == 'OCUPADO' || e.estado.name() == 'RESERVADO') && reservaActiva != null && reservaActiva.espacio.idEspacio == e.idEspacio ? reservaActiva.vehiculo.placa : ''}"></span>
        </div>
    </div>
    
    <!-- Script JS para WebSocket -->
    <script th:src="@{/js/app.js}"></script>
</main>
</html>